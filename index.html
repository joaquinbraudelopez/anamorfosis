<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Anam√≥rfico (Versi√≥n Abanico)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        
        /* Estilos pantalla */
        .no-print { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { font-size: 1.5rem; color: #444; margin-bottom: 10px; }
        
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; margin-bottom: 20px;}
        .btn { border: 2px solid #555; color: #555; background-color: white; padding: 8px 20px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        
        input[type="range"] { width: 100%; margin: 15px 0; }
        
        button.print-btn { background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px;}
        button.print-btn:hover { background: #0056b3; }

        #canvas-container { margin-top: 20px; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        canvas { 
            max-width: 90%; 
            height: auto; 
            border: 1px dashed #ccc; 
        }

        /* --- CONFIGURACI√ìN DE IMPRESI√ìN BLINDADA --- */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0; /* Elimina margenes del navegador */
            }
            body, html {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background: white;
                /* Flexbox para centrar absoluto */
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden; /* Evita que salga una segunda hoja si sobra un pixel */
            }
            .no-print { display: none !important; } 
            
            #canvas-container { 
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                page-break-inside: avoid; /* Prohibido cortar esto */
            }
            
            canvas {
                /* Forzamos el tama√±o correcto */
                width: 15cm !important; 
                height: 15cm !important; 
                max-width: 15cm !important;
                border: none;
                display: block;
            }
        }
    </style>
</head>
<body>

<div class="no-print">
    <h1>üé® Versi√≥n Abanico (180¬∞)</h1>
    <p>La imagen se curvar√° en un semic√≠rculo frente al cilindro.<br>Tama√±o de impresi√≥n: <strong>15 cm</strong> (Agujero: 6 cm).</p>
    
    <div class="upload-btn-wrapper">
        <button class="btn">üìÇ Seleccionar Foto</button>
        <input type="file" id="upload" accept="image/*">
    </div>

    <div id="controls" style="display:none;">
        <label>üîç Zoom</label>
        <input type="range" id="scale" min="50" max="250" value="100">
        
        <br>
        <button class="print-btn" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
        <p style="font-size: 0.85rem; margin-top:15px; background: #fff3cd; padding: 10px; border-radius: 5px; display: inline-block;">
            ‚ö†Ô∏è Configura la impresi√≥n en escala <strong>100%</strong>.
        </p>
    </div>
</div>

<div id="canvas-container">
    <canvas id="canvas"></canvas>
</div>

<script>
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scaleSlider = document.getElementById('scale');
    const controlsDiv = document.getElementById('controls');

    let img = new Image();
    let isImageLoaded = false;

    // --- MATEM√ÅTICA ---
    const FIXED_HOLE_RATIO = 6 / 15; 
    // Usamos 180 grados (PI) para que la imagen se vea de frente sin dar la vuelta entera
    const SECTOR_ANGLE = Math.PI; 

    upload.addEventListener('change', (e) => {
        if(e.target.files && e.target.files[0]){
            const reader = new FileReader();
            reader.onload = (event) => {
                img.onload = () => {
                    isImageLoaded = true;
                    controlsDiv.style.display = 'block';
                    draw();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    scaleSlider.addEventListener('input', draw);

    function draw() {
        if (!isImageLoaded) return;

        const size = 2000; 
        canvas.width = size;
        canvas.height = size;
        
        const cx = size / 2;
        const cy = size / 2;
        const radius = size / 2; 
        
        // Limpiar
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, size, size);

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = img.width;
        tempCanvas.height = img.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(img, 0, 0);
        const sourceData = tempCtx.getImageData(0, 0, img.width, img.height);

        const destImageData = ctx.createImageData(size, size);
        const data = destImageData.data;

        const rInner = size * (FIXED_HOLE_RATIO / 2); 
        const zoom = scaleSlider.value / 100;

        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const dx = x - cx;
                const dy = y - cy;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > radius || dist < rInner) continue;

                // Calcular √°ngulo
                // Math.atan2 devuelve de -PI a PI
                // Queremos que la imagen est√© ABAJO (semic√≠rculo inferior)
                // En canvas, Y crece hacia abajo.
                // 0 es derecha, PI/2 es abajo, PI es izquierda.
                
                let angle = Math.atan2(dy, dx); 
                
                // Rotamos 90 grados (-PI/2) para que el "centro" de nuestro abanico sea el eje Y positivo (abajo)
                // Ahora el √°ngulo 0 estar√≠a abajo.
                let adjustedAngle = angle - (Math.PI / 2);
                
                // Normalizar √°ngulo entre -PI y PI
                if (adjustedAngle < -Math.PI) adjustedAngle += 2 * Math.PI;
                if (adjustedAngle > Math.PI) adjustedAngle -= 2 * Math.PI;

                // Definimos el sector: desde -PI/2 (-90deg) a +PI/2 (+90deg) respecto al eje vertical
                // Esto cubre 180 grados en la parte inferior del c√≠rculo
                const halfSector = SECTOR_ANGLE / 2;

                if (Math.abs(adjustedAngle) > halfSector) {
                    // Si estamos fuera del abanico de 180 grados, no pintar (dejar blanco)
                    continue; 
                }

                // Mapear el √°ngulo (-PI/2 a PI/2) al ancho de la imagen (0 a width)
                // Sumamos halfSector para ir de 0 a SECTOR_ANGLE
                const anglePercent = (adjustedAngle + halfSector) / SECTOR_ANGLE;
                const u = anglePercent * img.width;

                // Mapear distancia (rInner a Radius) al alto de la imagen (height a 0)
                const distNormalizada = (dist - rInner) / (radius - rInner);
                const v = (1 - distNormalizada) * img.height * zoom;

                if (v < 0 || v >= img.height) continue;

                const srcX = Math.floor(u);
                const srcY = Math.floor(v);
                
                // Clamp para evitar errores de borde
                const safeX = Math.min(Math.max(srcX, 0), img.width - 1);
                const safeY = Math.min(Math.max(srcY, 0), img.height - 1);

                const srcIndex = (safeY * img.width + safeX) * 4;
                const destIndex = (y * size + x) * 4;

                data[destIndex] = sourceData.data[srcIndex];
                data[destIndex + 1] = sourceData.data[srcIndex + 1];
                data[destIndex + 2] = sourceData.data[srcIndex + 2];
                data[destIndex + 3] = 255;
            }
        }

        ctx.putImageData(destImageData, 0, 0);
        
        // L√≠neas de corte y gu√≠a
        ctx.beginPath();
        // Dibujamos solo el arco donde hay imagen
        ctx.arc(cx, cy, radius - 2, 0, 2 * Math.PI); // C√≠rculo completo tenue para recortar f√°cil
        ctx.strokeStyle = "#eeeeee";
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(cx, cy, rInner, 0, 2 * Math.PI);
        ctx.strokeStyle = "#cccccc";
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.fillStyle = "#ccc";
        ctx.font = "60px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("√ò 6cm", cx, cy);
        
        // Indicador de "FRENTE"
        ctx.fillStyle = "#999";
        ctx.font = "40px Arial";
        ctx.fillText("‚¨áÔ∏è FRENTE ‚¨áÔ∏è", cx, size - 50);
    }
</script>

</body>
</html>
